/**
 * Copyright 2013, 2014 IBM Corp.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

module.exports = function(RED) {
    "use strict";
    var dat = require('dat')
    var bops = require('bops')
    var sleep = require('sleep');


    function DatNode(n) {
      var db
      var dbStream
      db = dat('./mydat', function(err) {
        console.log(err)
        dbStream = db.createWriteStream()
      })
        RED.nodes.createNode(this,n);
        this.reponame = n.datreponame || "";
        this.name = n.name || "";
        var node = this;
        // var db
        // var dbStream
        this.on("input",function(msg) {
          dbStream.write(JSON.stringify(msg))
          // console.log(dbStream)
          // process.exit()
          // RED.settings.dat.write(msg)

        // var reponame = this.reponame;
            //if (msg.reponame) {
            //    if (n.datreponame && (n.datreponame !== msg.datreponame)) {
            //        node.warn("Deprecated: msg properties should not override set node properties. See bit.ly/nr-override-msg-props");
            //    }
            //    reponame = msg.reponame;
            //} else {
            //    reponame = this.reponame;
            //}

            //if (reponame === "") {
            //    console.log("No filename");
            //    node.warn('No filename specified');
            //}
            //else if (typeof msg.payload != "undefined") {
            // console.log('ola')
                // var data = msg.payload;
                //if ((typeof data === "object")&&(!Buffer.isBuffer(data))) {
                    // data = JSON.stringify(data);
                    // console.log(reponame)
                    // console.log('if')
                    // console.log(msg)
                    // if (!db) {
                    //    console.log('creating db')
                    	// db = dat(reponame, function(err) {
                      // dbStream = db.createWriteStream({ json: true, quiet: true })

                      // console.log(dbStream)
                      // dbStream.write(bops.from(JSON.stringify(msg)))
                      // dbStream.end()
                        // console.log(error)
                    	  //  console.log('db created. writing')
                    	  //  dbStream = db.put()
                    	  //  node.send(data)
                        // db.put(JSON.stringify(msg))
                    	// })
                      // sleep.sleep(20)//sleep for 5 seconds
                      // dbStream.write(data)
                    // } else {
                      //  console.log('db exists, just writing')
                      //  dbStream.write(bops.from(JSON.stringify(msg)))
                      //  dbStream.end()

                      // dbStream.write(data)
                      // node.send(data)
                      // db.put(JSON.stringify(msg))
                    // }

                      //console.log(db)
                      //console.log('2')
                      //var writeStream  = db.createWriteStream()
                      //writeStream.write(data)
                    // })
            //    }

            //}
        });
    }
    RED.nodes.registerType("dat-out",DatNode);
}
